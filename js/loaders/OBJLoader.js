/*
* @author mrdoob / http://mrdoob.com/
*/

THREE.OBJLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.materials=null,this.regexp={vertex_pattern:/^v\s+([\d\.\+\-eE]+)\s+([\d\.\+\-eE]+)\s+([\d\.\+\-eE]+)/,normal_pattern:/^vn\s+([\d\.\+\-eE]+)\s+([\d\.\+\-eE]+)\s+([\d\.\+\-eE]+)/,uv_pattern:/^vt\s+([\d\.\+\-eE]+)\s+([\d\.\+\-eE]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /}},THREE.OBJLoader.prototype={constructor:THREE.OBJLoader,load:function(e,t,r,s){var i=this,a=new THREE.FileLoader(i.manager);a.setPath(this.path),a.load(e,function(e){t(i.parse(e))},r,s)},setPath:function(e){this.path=e},setMaterials:function(e){this.materials=e},_createParserState:function(){var e={objects:[],object:{},vertices:[],normals:[],uvs:[],materialLibraries:[],startObject:function(e,t){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=e,void(this.object.fromDeclaration=!1!==t);var r=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:!1!==t,geometry:{vertices:[],normals:[],uvs:[]},materials:[],smooth:!0,startMaterial:function(e,t){var r=this._finalize(!1);r&&(r.inherited||r.groupCount<=0)&&this.materials.splice(r.index,1);var s={index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&0<t.length?t[t.length-1]:"",smooth:void 0!==r?r.smooth:this.smooth,groupStart:void 0!==r?r.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){var t={index:"number"==typeof e?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return t.clone=this.clone.bind(t),t}};return this.materials.push(s),s},currentMaterial:function(){if(0<this.materials.length)return this.materials[this.materials.length-1]},_finalize:function(e){var t=this.currentMaterial();if(t&&-1===t.groupEnd&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),e&&1<this.materials.length)for(var r=this.materials.length-1;0<=r;r--)this.materials[r].groupCount<=0&&this.materials.splice(r,1);return e&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),t}},r&&r.name&&"function"==typeof r.clone){var s=r.clone(0);s.inherited=!0,this.object.materials.push(s)}this.objects.push(this.object)},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0)},parseVertexIndex:function(e,t){var r=parseInt(e,10);return 3*(0<=r?r-1:r+t/3)},parseNormalIndex:function(e,t){var r=parseInt(e,10);return 3*(0<=r?r-1:r+t/3)},parseUVIndex:function(e,t){var r=parseInt(e,10);return 2*(0<=r?r-1:r+t/2)},addVertex:function(e,t,r){var s=this.vertices,i=this.object.geometry.vertices;i.push(s[e+0]),i.push(s[e+1]),i.push(s[e+2]),i.push(s[t+0]),i.push(s[t+1]),i.push(s[t+2]),i.push(s[r+0]),i.push(s[r+1]),i.push(s[r+2])},addVertexLine:function(e){var t=this.vertices,r=this.object.geometry.vertices;r.push(t[e+0]),r.push(t[e+1]),r.push(t[e+2])},addNormal:function(e,t,r){var s=this.normals,i=this.object.geometry.normals;i.push(s[e+0]),i.push(s[e+1]),i.push(s[e+2]),i.push(s[t+0]),i.push(s[t+1]),i.push(s[t+2]),i.push(s[r+0]),i.push(s[r+1]),i.push(s[r+2])},addUV:function(e,t,r){var s=this.uvs,i=this.object.geometry.uvs;i.push(s[e+0]),i.push(s[e+1]),i.push(s[t+0]),i.push(s[t+1]),i.push(s[r+0]),i.push(s[r+1])},addUVLine:function(e){var t=this.uvs,r=this.object.geometry.uvs;r.push(t[e+0]),r.push(t[e+1])},addFace:function(e,t,r,s,i,a,n,o,h,l,d,u){var p,c=this.vertices.length,m=this.parseVertexIndex(e,c),f=this.parseVertexIndex(t,c),v=this.parseVertexIndex(r,c);if(void 0===s?this.addVertex(m,f,v):(p=this.parseVertexIndex(s,c),this.addVertex(m,f,p),this.addVertex(f,v,p)),void 0!==i){var g=this.uvs.length;m=this.parseUVIndex(i,g),f=this.parseUVIndex(a,g),v=this.parseUVIndex(n,g),void 0===s?this.addUV(m,f,v):(p=this.parseUVIndex(o,g),this.addUV(m,f,p),this.addUV(f,v,p))}if(void 0!==h){var x=this.normals.length;m=this.parseNormalIndex(h,x),f=h===l?m:this.parseNormalIndex(l,x),v=h===d?m:this.parseNormalIndex(d,x),void 0===s?this.addNormal(m,f,v):(p=this.parseNormalIndex(u,x),this.addNormal(m,f,p),this.addNormal(f,v,p))}},addLineGeometry:function(e,t){this.object.geometry.type="Line";for(var r=this.vertices.length,s=this.uvs.length,i=0,a=e.length;i<a;i++)this.addVertexLine(this.parseVertexIndex(e[i],r));var n=0;for(a=t.length;n<a;n++)this.addUVLine(this.parseUVIndex(t[n],s))}};return e.startObject("",!1),e},parse:function(e){console.time("OBJLoader");var t=this._createParserState();-1!==e.indexOf("\r\n")&&(e=e.replace(/\r\n/g,"\n")),-1!==e.indexOf("\\\n")&&(e=e.replace(/\\\n/g,""));for(var r=e.split("\n"),s="",i="",a="",n=[],o="function"==typeof"".trimLeft,h=0,l=r.length;h<l;h++)if(s=r[h],0!==(s=o?s.trimLeft():s.trim()).length&&"#"!==(i=s.charAt(0)))if("v"===i)if(" "===(a=s.charAt(1))&&null!==(n=this.regexp.vertex_pattern.exec(s)))t.vertices.push(parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3]));else if("n"===a&&null!==(n=this.regexp.normal_pattern.exec(s)))t.normals.push(parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3]));else{if("t"!==a||null===(n=this.regexp.uv_pattern.exec(s)))throw new Error("Unexpected vertex/normal/uv line: '"+s+"'");t.uvs.push(parseFloat(n[1]),parseFloat(n[2]))}else if("f"===i)if(null!==(n=this.regexp.face_vertex_uv_normal.exec(s)))t.addFace(n[1],n[4],n[7],n[10],n[2],n[5],n[8],n[11],n[3],n[6],n[9],n[12]);else if(null!==(n=this.regexp.face_vertex_uv.exec(s)))t.addFace(n[1],n[3],n[5],n[7],n[2],n[4],n[6],n[8]);else if(null!==(n=this.regexp.face_vertex_normal.exec(s)))t.addFace(n[1],n[3],n[5],n[7],void 0,void 0,void 0,void 0,n[2],n[4],n[6],n[8]);else{if(null===(n=this.regexp.face_vertex.exec(s)))throw new Error("Unexpected face line: '"+s+"'");t.addFace(n[1],n[2],n[3],n[4])}else if("l"===i){var d=s.substring(1).trim().split(" "),u=[],p=[];if(-1===s.indexOf("/"))u=d;else for(var c=0,m=d.length;c<m;c++){var f=d[c].split("/");""!==f[0]&&u.push(f[0]),""!==f[1]&&p.push(f[1])}t.addLineGeometry(u,p)}else if(null!==(n=this.regexp.object_pattern.exec(s))){var v=(" "+n[0].substr(1).trim()).substr(1);t.startObject(v)}else if(this.regexp.material_use_pattern.test(s))t.object.startMaterial(s.substring(7).trim(),t.materialLibraries);else if(this.regexp.material_library_pattern.test(s))t.materialLibraries.push(s.substring(7).trim());else{if(null===(n=this.regexp.smoothing_pattern.exec(s))){if("\0"===s)continue;throw new Error("Unexpected line: '"+s+"'")}var g=n[1].trim().toLowerCase();t.object.smooth="0"!==g&&"off"!==g,(R=t.object.currentMaterial())&&(R.smooth=t.object.smooth)}t.finalize();var x=new THREE.Group;x.materialLibraries=[].concat(t.materialLibraries);for(h=0,l=t.objects.length;h<l;h++){var b=t.objects[h],E=b.geometry,_=b.materials,j="Line"===E.type;if(0!==E.vertices.length){var y=new THREE.BufferGeometry;y.addAttribute("position",new THREE.BufferAttribute(new Float32Array(E.vertices),3)),0<E.normals.length?y.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(E.normals),3)):y.computeVertexNormals(),0<E.uvs.length&&y.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(E.uvs),2));for(var L,V=[],w=0,H=_.length;w<H;w++){var I=_[w],R=void 0;if(null!==this.materials&&(R=this.materials.create(I.name),j&&R&&!(R instanceof THREE.LineBasicMaterial))){var T=new THREE.LineBasicMaterial;T.copy(R),R=T}R||((R=j?new THREE.LineBasicMaterial:new THREE.MeshPhongMaterial).name=I.name),R.shading=I.smooth?THREE.SmoothShading:THREE.FlatShading,V.push(R)}if(1<V.length){for(w=0,H=_.length;w<H;w++){I=_[w];y.addGroup(I.groupStart,I.groupCount,w)}L=j?new THREE.LineSegments(y,V):new THREE.Mesh(y,V)}else L=j?new THREE.LineSegments(y,V[0]):new THREE.Mesh(y,V[0]);L.name=b.name,x.add(L)}}return console.timeEnd("OBJLoader"),x}};